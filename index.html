<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CSV JSON Sorter Tool</title>
  <style id="theme-style">
    :root {
      --bg-color: #f5f7fa;
      --text-color: #333;
      --box-bg: #fff;
      --border-color: #ccc;
      --table-header: #e0e0e0;
      --highlight: yellow;
    }

    [data-theme='dark'] {
      --bg-color: #1e1e1e;
      --text-color: #eee;
      --box-bg: #2b2b2b;
      --border-color: #444;
      --table-header: #3c3c3c;
      --highlight: orange;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      padding: 20px;
    }

    h2, h3 {
      margin: 10px 0;
    }

    input, textarea, button {
      padding: 8px 12px;
      margin: 10px 5px;
      font-size: 14px;
    }

    textarea {
      font-family: monospace;
      resize: both;
      width: 100%;
      min-height: 250px;
      box-sizing: border-box;
    }

    .flex-container {
      display: flex;
      gap: 20px;
      flex-wrap: nowrap;
      margin-bottom: 20px;
    }

    .box {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 300px;
    }

    .output-box {
      background: var(--box-bg);
      border: 1px solid var(--border-color);
      padding: 10px;
      flex: 1;
      overflow: auto;
      white-space: pre-wrap;
      height: 100%;
      resize: both;
      margin-top: 34px;
    }

    .output-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      background: var(--box-bg);
    }

    th, td {
      border: 1px solid var(--border-color);
      padding: 8px;
      text-align: left;
      white-space: nowrap;
    }

    th {
      background-color: var(--table-header);
    }

    col.resizeable {
      resize: horizontal;
      overflow: auto;
    }

    tr:nth-child(even) {
      background-color: rgba(0, 0, 0, 0.03);
    }

    .highlight {
      background-color: var(--highlight);
      font-weight: bold;
    }
  </style>
</head>
<body data-theme="light">

  <h2>CSV JSON Sorting Tool</h2>

  <button onclick="toggleTheme()">üåì Toggle Theme</button>

  <div class="flex-container">
    <div class="box">
      <h3>Paste Nested JSON</h3>
      <textarea id="jsonInput" placeholder='[{"S":"default"},{"S":"eight8xl"}]'></textarea>
    </div>
    <div class="box">
      <div class="output-header">
        <h3>Sorted Output</h3>
        <button onclick="copySorted()">üìã Copy</button>
      </div>
      <div class="output-box" id="jsonOutput">Sorted values will appear here...</div>
    </div>
  </div>

  <input type="file" id="csvFileInput" accept=".csv,.txt" />
  <button id="loadButton">üì• Load & Process</button>
  <input type="text" id="searchBox" placeholder="Search in table..." />
  <button onclick="copyTable()">üìã Copy Table</button>
  <button onclick="downloadCSV()">‚¨áÔ∏è Download CSV</button>

  <div style="overflow-x: auto;">
    <div id="tableContainer"></div>
  </div>

  <script>
    let fileContent = '';
    let processedData = [];
    const headers = ["OverRideID", "JsonColumn"];

    document.getElementById('jsonInput').addEventListener('input', () => {
      const input = document.getElementById('jsonInput').value.trim();
      const output = document.getElementById('jsonOutput');
      if (!input) return output.textContent = 'Sorted values will appear here...';
      try {
        const parsed = JSON.parse(input);
        const sorted = parsed.map(o => o.S).sort().join(', ');
        output.textContent = sorted;
      } catch (e) {
        output.textContent = '‚ùå Invalid JSON format';
      }
    });

    document.getElementById('csvFileInput').addEventListener('change', function (event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (e) {
        fileContent = e.target.result;
        alert("‚úÖ File loaded! Now click 'Load & Process'");
      };
      reader.readAsText(file);
    });

    document.getElementById('loadButton').addEventListener('click', () => {
      if (!fileContent) return alert("‚ö†Ô∏è Upload a file first.");
      const lines = fileContent.trim().split(/\r?\n/);
      processedData = [];

      lines.forEach((line, index) => {
        const parts = line.match(/^([^,]+),"(.*)"$/);
        if (!parts || parts.length < 3) {
          console.warn(`‚ö†Ô∏è Skipping line ${index + 1}: Invalid format`);
          return;
        }
        const id = parts[1].trim();
        const rawJsonStr = parts[2].replace(/""/g, '"').trim();
        let sortedVal = "Error: Invalid JSON";
        try {
          const json = JSON.parse(rawJsonStr);
          const values = json.map(obj => obj.S);
          sortedVal = values.sort().join(', ');
        } catch (e) {
          console.error(`‚ùå Invalid JSON at line ${index + 1}`);
        }
        processedData.push([id, rawJsonStr, sortedVal]);
      });

      renderTable(processedData);
    });

    function renderTable(data) {
      const searchTerm = document.getElementById('searchBox').value.toLowerCase();
      let html = `<table><colgroup><col class="resizeable"><col class="resizeable"><col class="resizeable"></colgroup><thead><tr><th>${headers[0]}</th><th>${headers[1]}</th><th>SortedValues</th></tr></thead><tbody>`;

      data.forEach(row => {
        if (searchTerm && !row.join(' ').toLowerCase().includes(searchTerm)) return;
        html += '<tr>';
        row.forEach(cell => {
          html += `<td>${highlight(cell, searchTerm)}</td>`;
        });
        html += '</tr>';
      });

      html += '</tbody></table>';
      document.getElementById('tableContainer').innerHTML = html;
    }

    document.getElementById('searchBox').addEventListener('input', () => renderTable(processedData));

    function highlight(text, term) {
      if (!term) return text;
      const regex = new RegExp(`(${term})`, 'gi');
      return text.replace(regex, '<span class="highlight">$1</span>');
    }

    function copyTable() {
      const table = document.querySelector('#tableContainer table');
      if (!table) return alert('‚ö†Ô∏è No table to copy.');
      const range = document.createRange();
      range.selectNode(table);
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);
      document.execCommand('copy');
      sel.removeAllRanges();
      alert('‚úÖ Table copied to clipboard.');
    }

    function copySorted() {
      const text = document.getElementById('jsonOutput').textContent;
      navigator.clipboard.writeText(text).then(() => {
        alert("‚úÖ Sorted value copied!");
      });
    }

    function downloadCSV() {
      if (!processedData.length) return alert("‚ö†Ô∏è Nothing to download.");
      let csv = `${headers[0]},${headers[1]},SortedValues\n`;
      processedData.forEach(row => {
        csv += row.map(cell => `"${cell.replace(/"/g, '""')}"`).join(',') + '\n';
      });
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'output.csv';
      link.click();
      URL.revokeObjectURL(link.href);
    }

    function toggleTheme() {
      const body = document.body;
      const current = body.getAttribute('data-theme');
      body.setAttribute('data-theme', current === 'dark' ? 'light' : 'dark');
    }
  </script>
</body>
</html>
